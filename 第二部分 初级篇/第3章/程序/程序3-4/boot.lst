     1                                  ;/***************************************************
     2                                  ;		版权声明
     3                                  ;
     4                                  ;	本操作系统名为：MINE
     5                                  ;	该操作系统未经授权不得以盈利或非盈利为目的进行开发，
     6                                  ;	只允许个人学习以及公开交流使用
     7                                  ;
     8                                  ;	代码最终所有权及解释权归田宇所有；
     9                                  ;
    10                                  ;	本模块作者：	田宇
    11                                  ;	EMail:		345538255@qq.com
    12                                  ;
    13                                  ;
    14                                  ;***************************************************/
    15                                  
    16                                  	org	0x7c00	
    17                                  
    18                                  BaseOfStack	equ	0x7c00
    19                                  
    20                                  BaseOfLoader	equ	0x1140
    21                                  OffsetOfLoader	equ	0x00
    22                                  
    23                                  RootDirSectors	equ	14
    24                                  SectorNumOfRootDirStart	equ	19
    25                                  SectorNumOfFAT1Start	equ	1
    26                                  SectorBalance	equ	17	
    27                                  
    28 00000000 EB3C                    	jmp	short Label_Start
    29 00000002 90                      	nop
    30 00000003 4D494E45626F6F74        	BS_OEMName	db	'MINEboot'
    31 0000000B 0002                    	BPB_BytesPerSec	dw	512
    32 0000000D 01                      	BPB_SecPerClus	db	1
    33 0000000E 0100                    	BPB_RsvdSecCnt	dw	1
    34 00000010 02                      	BPB_NumFATs	db	2
    35 00000011 E000                    	BPB_RootEntCnt	dw	224
    36 00000013 400B                    	BPB_TotSec16	dw	2880
    37 00000015 F0                      	BPB_Media	db	0xf0
    38 00000016 0900                    	BPB_FATSz16	dw	9
    39 00000018 1200                    	BPB_SecPerTrk	dw	18
    40 0000001A 0200                    	BPB_NumHeads	dw	2
    41 0000001C 00000000                	BPB_HiddSec	dd	0
    42 00000020 00000000                	BPB_TotSec32	dd	0
    43 00000024 00                      	BS_DrvNum	db	0
    44 00000025 00                      	BS_Reserved1	db	0
    45 00000026 29                      	BS_BootSig	db	0x29
    46 00000027 00000000                	BS_VolID	dd	0
    47 0000002B 626F6F74206C6F6164-     	BS_VolLab	db	'boot loader'
    47 00000034 6572               
    48 00000036 4641543132202020        	BS_FileSysType	db	'FAT12   '
    49                                  
    50                                  Label_Start:
    51                                  
    52 0000003E 8CC8                    	mov	ax,	cs
    53 00000040 8ED8                    	mov	ds,	ax
    54 00000042 8EC0                    	mov	es,	ax
    55 00000044 8ED0                    	mov	ss,	ax
    56 00000046 BC007C                  	mov	sp,	BaseOfStack
    57                                  
    58                                  ;=======	clear screen
    59                                  
    60 00000049 B80006                  	mov	ax,	0600h
    61 0000004C BB0007                  	mov	bx,	0700h
    62 0000004F B90000                  	mov	cx,	0
    63 00000052 BA4F18                  	mov	dx,	0184fh
    64 00000055 CD10                    	int	10h
    65                                  
    66                                  ;=======	set focus
    67                                  
    68 00000057 B80002                  	mov	ax,	0200h
    69 0000005A BB0000                  	mov	bx,	0000h
    70 0000005D BA0000                  	mov	dx,	0000h
    71 00000060 CD10                    	int	10h
    72                                  
    73                                  ;=======	display on screen : Start Booting......
    74                                  
    75 00000062 B80113                  	mov	ax,	1301h
    76 00000065 BB0F00                  	mov	bx,	000fh
    77 00000068 BA0000                  	mov	dx,	0000h
    78 0000006B B90A00                  	mov	cx,	10
    79 0000006E 50                      	push	ax
    80 0000006F 8CD8                    	mov	ax,	ds
    81 00000071 8EC0                    	mov	es,	ax
    82 00000073 58                      	pop	ax
    83 00000074 BD[BC01]                	mov	bp,	StartBootMessage
    84 00000077 CD10                    	int	10h
    85                                  
    86                                  ;=======	reset floppy
    87                                  
    88 00000079 30E4                    	xor	ah,	ah
    89 0000007B 30D2                    	xor	dl,	dl
    90 0000007D CD13                    	int	13h
    91                                  
    92                                  ;=======	search loader.bin
    93 0000007F C706[B901]1300          	mov	word	[SectorNo],	SectorNumOfRootDirStart
    94                                  
    95                                  Lable_Search_In_Root_Dir_Begin:
    96                                  
    97 00000085 833E[B701]00            	cmp	word	[RootDirSizeForLoop],	0
    98 0000008A 744A                    	jz	Label_No_LoaderBin
    99 0000008C FF0E[B701]              	dec	word	[RootDirSizeForLoop]	
   100 00000090 B80000                  	mov	ax,	00h
   101 00000093 8EC0                    	mov	es,	ax
   102 00000095 BB0080                  	mov	bx,	8000h
   103 00000098 A1[B901]                	mov	ax,	[SectorNo]
   104 0000009B B101                    	mov	cl,	1
   105 0000009D E89900                  	call	Func_ReadOneSector
   106 000000A0 BE[DB01]                	mov	si,	LoaderFileName
   107 000000A3 BF0080                  	mov	di,	8000h
   108 000000A6 FC                      	cld
   109 000000A7 BA1000                  	mov	dx,	10h
   110                                  	
   111                                  Label_Search_For_LoaderBin:
   112                                  
   113 000000AA 83FA00                  	cmp	dx,	0
   114 000000AD 7420                    	jz	Label_Goto_Next_Sector_In_Root_Dir
   115 000000AF 4A                      	dec	dx
   116 000000B0 B90B00                  	mov	cx,	11
   117                                  
   118                                  Label_Cmp_FileName:
   119                                  
   120 000000B3 83F900                  	cmp	cx,	0
   121 000000B6 7437                    	jz	Label_FileName_Found
   122 000000B8 49                      	dec	cx
   123 000000B9 AC                      	lodsb	
   124 000000BA 263A05                  	cmp	al,	byte	[es:di]
   125 000000BD 7402                    	jz	Label_Go_On
   126 000000BF EB03                    	jmp	Label_Different
   127                                  
   128                                  Label_Go_On:
   129                                  	
   130 000000C1 47                      	inc	di
   131 000000C2 EBEF                    	jmp	Label_Cmp_FileName
   132                                  
   133                                  Label_Different:
   134                                  
   135 000000C4 83E7E0                  	and	di,	0ffe0h
   136 000000C7 83C720                  	add	di,	20h
   137 000000CA BE[DB01]                	mov	si,	LoaderFileName
   138 000000CD EBDB                    	jmp	Label_Search_For_LoaderBin
   139                                  
   140                                  Label_Goto_Next_Sector_In_Root_Dir:
   141                                  	
   142 000000CF 8306[B901]01            	add	word	[SectorNo],	1
   143 000000D4 EBAF                    	jmp	Lable_Search_In_Root_Dir_Begin
   144                                  	
   145                                  ;=======	display on screen : ERROR:No LOADER Found
   146                                  
   147                                  Label_No_LoaderBin:
   148                                  
   149 000000D6 B80113                  	mov	ax,	1301h
   150 000000D9 BB8C00                  	mov	bx,	008ch
   151 000000DC BA0001                  	mov	dx,	0100h
   152 000000DF B91500                  	mov	cx,	21
   153 000000E2 50                      	push	ax
   154 000000E3 8CD8                    	mov	ax,	ds
   155 000000E5 8EC0                    	mov	es,	ax
   156 000000E7 58                      	pop	ax
   157 000000E8 BD[C601]                	mov	bp,	NoLoaderMessage
   158 000000EB CD10                    	int	10h
   159 000000ED EBFE                    	jmp	$
   160                                  
   161                                  ;=======	found loader.bin name in root director struct
   162                                  
   163                                  Label_FileName_Found:
   164                                  
   165 000000EF B80E00                  	mov	ax,	RootDirSectors
   166 000000F2 83E7E0                  	and	di,	0ffe0h
   167 000000F5 83C71A                  	add	di,	01ah
   168 000000F8 268B0D                  	mov	cx,	word	[es:di]
   169 000000FB 51                      	push	cx
   170 000000FC 01C1                    	add	cx,	ax
   171 000000FE 83C111                  	add	cx,	SectorBalance
   172 00000101 B84011                  	mov	ax,	BaseOfLoader
   173 00000104 8EC0                    	mov	es,	ax
   174 00000106 BB0000                  	mov	bx,	OffsetOfLoader
   175 00000109 89C8                    	mov	ax,	cx
   176                                  
   177                                  Label_Go_On_Loading_File:
   178 0000010B 50                      	push	ax
   179 0000010C 53                      	push	bx
   180 0000010D B40E                    	mov	ah,	0eh
   181 0000010F B02E                    	mov	al,	'.'
   182 00000111 B30F                    	mov	bl,	0fh
   183 00000113 CD10                    	int	10h
   184 00000115 5B                      	pop	bx
   185 00000116 58                      	pop	ax
   186                                  
   187 00000117 B101                    	mov	cl,	1
   188 00000119 E81D00                  	call	Func_ReadOneSector
   189 0000011C 58                      	pop	ax
   190 0000011D E84B00                  	call	Func_GetFATEntry
   191 00000120 3DFF0F                  	cmp	ax,	0fffh
   192 00000123 740F                    	jz	Label_File_Loaded
   193 00000125 50                      	push	ax
   194 00000126 BA0E00                  	mov	dx,	RootDirSectors
   195 00000129 01D0                    	add	ax,	dx
   196 0000012B 83C011                  	add	ax,	SectorBalance
   197 0000012E 031E[0B00]              	add	bx,	[BPB_BytesPerSec]
   198 00000132 EBD7                    	jmp	Label_Go_On_Loading_File
   199                                  
   200                                  Label_File_Loaded:
   201                                  	
   202 00000134 EA00004011              	jmp	BaseOfLoader:OffsetOfLoader
   203                                  
   204                                  ;=======	read one sector from floppy
   205                                  
   206                                  Func_ReadOneSector:
   207                                  	
   208 00000139 55                      	push	bp
   209 0000013A 89E5                    	mov	bp,	sp
   210 0000013C 6683EC02                	sub	esp,	2
   211 00000140 884EFE                  	mov	byte	[bp - 2],	cl
   212 00000143 53                      	push	bx
   213 00000144 8A1E[1800]              	mov	bl,	[BPB_SecPerTrk]
   214 00000148 F6F3                    	div	bl
   215 0000014A FEC4                    	inc	ah
   216 0000014C 88E1                    	mov	cl,	ah
   217 0000014E 88C6                    	mov	dh,	al
   218 00000150 D0E8                    	shr	al,	1
   219 00000152 88C5                    	mov	ch,	al
   220 00000154 80E601                  	and	dh,	1
   221 00000157 5B                      	pop	bx
   222 00000158 8A16[2400]              	mov	dl,	[BS_DrvNum]
   223                                  Label_Go_On_Reading:
   224 0000015C B402                    	mov	ah,	2
   225 0000015E 8A46FE                  	mov	al,	byte	[bp - 2]
   226 00000161 CD13                    	int	13h
   227 00000163 72F7                    	jc	Label_Go_On_Reading
   228 00000165 6683C402                	add	esp,	2
   229 00000169 5D                      	pop	bp
   230 0000016A C3                      	ret
   231                                  
   232                                  ;=======	get FAT Entry
   233                                  
   234                                  Func_GetFATEntry:
   235                                  
   236 0000016B 06                      	push	es
   237 0000016C 53                      	push	bx
   238 0000016D 50                      	push	ax
   239 0000016E B80000                  	mov	ax,	00
   240 00000171 8EC0                    	mov	es,	ax
   241 00000173 58                      	pop	ax
   242 00000174 C606[BB01]00            	mov	byte	[Odd],	0
   243 00000179 BB0300                  	mov	bx,	3
   244 0000017C F7E3                    	mul	bx
   245 0000017E BB0200                  	mov	bx,	2
   246 00000181 F7F3                    	div	bx
   247 00000183 83FA00                  	cmp	dx,	0
   248 00000186 7405                    	jz	Label_Even
   249 00000188 C606[BB01]01            	mov	byte	[Odd],	1
   250                                  
   251                                  Label_Even:
   252                                  
   253 0000018D 31D2                    	xor	dx,	dx
   254 0000018F 8B1E[0B00]              	mov	bx,	[BPB_BytesPerSec]
   255 00000193 F7F3                    	div	bx
   256 00000195 52                      	push	dx
   257 00000196 BB0080                  	mov	bx,	8000h
   258 00000199 83C001                  	add	ax,	SectorNumOfFAT1Start
   259 0000019C B102                    	mov	cl,	2
   260 0000019E E898FF                  	call	Func_ReadOneSector
   261                                  	
   262 000001A1 5A                      	pop	dx
   263 000001A2 01D3                    	add	bx,	dx
   264 000001A4 268B07                  	mov	ax,	[es:bx]
   265 000001A7 803E[BB01]01            	cmp	byte	[Odd],	1
   266 000001AC 7503                    	jnz	Label_Even_2
   267 000001AE C1E804                  	shr	ax,	4
   268                                  
   269                                  Label_Even_2:
   270 000001B1 25FF0F                  	and	ax,	0fffh
   271 000001B4 5B                      	pop	bx
   272 000001B5 07                      	pop	es
   273 000001B6 C3                      	ret
   274                                  
   275                                  ;=======	tmp variable
   276                                  
   277 000001B7 0E00                    RootDirSizeForLoop	dw	RootDirSectors
   278 000001B9 0000                    SectorNo		dw	0
   279 000001BB 00                      Odd			db	0
   280                                  
   281                                  ;=======	display messages
   282                                  
   283 000001BC 537461727420426F6F-     StartBootMessage:	db	"Start Boot"
   283 000001C5 74                 
   284 000001C6 4552524F523A4E6F20-     NoLoaderMessage:	db	"ERROR:No LOADER Found"
   284 000001CF 4C4F4144455220466F-
   284 000001D8 756E64             
   285 000001DB 4C4F41444552202042-     LoaderFileName:		db	"LOADER  BIN",0
   285 000001E4 494E00             
   286                                  
   287                                  ;=======	fill zero until whole sector
   288                                  
   289 000001E7 00<rept>                	times	510 - ($ - $$)	db	0
   290 000001FE 55AA                    	dw	0xaa55
   291                                  
